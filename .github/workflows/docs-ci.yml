name: Docs CI

on:
  push:
    paths:
      - 'docs/crucible/**'
      - 'scripts/*.py'
      - 'experiments/*.py'
      - 'tools/docs_lint_crucible.py'
      - 'tools/extract_script_flags.py'
  pull_request:
    paths:
      - 'docs/crucible/**'
      - 'scripts/*.py'
      - 'experiments/*.py'
      - 'tools/docs_lint_crucible.py'
      - 'tools/extract_script_flags.py'

jobs:
  docs-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install -e . || true  # Best effort install

      - name: Regenerate CURRENT_IMPLEMENTATION.md
        run: python tools/extract_script_flags.py

      - name: Check for uncommitted changes (drift detection)
        run: |
          if git diff --exit-code docs/crucible/CURRENT_IMPLEMENTATION.md; then
            echo "✓ CURRENT_IMPLEMENTATION.md is up to date"
          else
            echo "✗ CURRENT_IMPLEMENTATION.md has drifted from script --help output"
            echo ""
            echo "Run 'python tools/extract_script_flags.py' locally and commit the changes"
            exit 1
          fi

      - name: Run docs linter
        run: python tools/docs_lint_crucible.py
